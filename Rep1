import os
import schedule
import time
import datetime
import socket
import psycopg2
import requests
import logging
from tabulate import tabulate

# Configure logging
logging.basicConfig(
    filename="replication_stats.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

# Set your PostgreSQL connection parameters
db_params = {
    "host": "your_postgres_host",
    "database": "your_database",
    "user": "your_user",
    "password": "your_password",
}

# Set the Confluence API endpoint and credentials
confluence_api_url = "https://your-confluence-site/rest/api/content/YOUR_PAGE_ID"  # Update with your Confluence page URL
confluence_username = "your_username"
confluence_password = "your_password"

# Directory to store data files
data_directory = "data"

# Function to fetch replication statistics and slots and format them as a table
def get_replication_stats():
    try:
        connection = psycopg2.connect(**db_params)
        cursor = connection.cursor()

        # Get replication statistics with headers
        cursor.execute("SELECT * FROM pg_stat_replication;")
        replication_stats = cursor.fetchall()
        replication_stats.insert(0, [desc[0] for desc in cursor.description])

        # Get replication slots with headers
        cursor.execute("SELECT * FROM pg_replication_slots;")
        replication_slots = cursor.fetchall()
        replication_slots.insert(0, [desc[0] for desc in cursor.description])

        return replication_stats, replication_slots
    except Exception as e:
        logging.error("Error fetching replication stats: %s", str(e))
    finally:
        if connection:
            connection.close()

# Function to write data to a text file with timestamp and hostname
def write_to_file(data):
    current_week = datetime.datetime.now().strftime("%U")
    current_datetime = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    filename = os.path.join(data_directory, f"replication_stats_week_{current_week}_{current_datetime}.txt")
    
    with open(filename, "a") as file:
        file.write("\n\n")
        file.write(f"Datetime: {current_datetime}\n")
        file.write(f"Hostname: {socket.gethostname()}\n\n")
        file.write("Replication Statistics:\n")
        file.write(tabulate(data[0], headers="firstrow", tablefmt="grid") + "\n\n")
        file.write("Replication Slots:\n")
        file.write(tabulate(data[1], headers="firstrow", tablefmt="grid") + "\n")
    
    return filename

# Function to publish file content as a Confluence attachment
def publish_to_confluence(filename):
    auth = (confluence_username, confluence_password)

    # Get the current Confluence page ID from the URL
    confluence_page_id = confluence_api_url.split("/")[-1]

    # Define the URL for uploading an attachment to the Confluence page
    upload_url = f"https://your-confluence-site/rest/api/content/{confluence_page_id}/child/attachment"

    # Set the headers for the attachment
    headers = {
        "X-Atlassian-Token": "nocheck",  # Disable CSRF token
    }

    with open(filename, "rb") as file:
        # Create a new attachment on the Confluence page
        response = requests.post(upload_url, auth=auth, headers=headers, files={"file": file})
        if response.status_code == 200:
            logging.info("Uploaded attachment to Confluence successfully.")
            os.remove(filename)  # Remove the file after uploading
        else:
            logging.error("Error uploading attachment to Confluence: %s", response.text)

# Schedule the task to run every 2 minutes
schedule.every(2).minutes.do(lambda: write_to_file(get_replication_stats()))

# Schedule the publishing task to run every hour
schedule.every().hour.do(lambda: publish_to_confluence(write_to_file(get_replication_stats())))

# Create the data directory if it doesn't exist
os.makedirs(data_directory, exist_ok=True)

# Run the scheduled tasks
while True:
    schedule.run_pending()
    time.sleep(1)
